<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>ShaderShop</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com"> 
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> 
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        html,body {
            width: 100%;
            height: 100%;
            overflow: shown;
            font-family: 'Quicksand', sans-serif;
        }
        body {
            background-color: rgb(13,17,23);
        }
        #editor { 
        position: absolute;
        top: 6.5rem;
        right: 1.5rem;
        bottom: 1.5rem;
        left: 40%;
    }
    .is-purple {
        background-color: #9448c7;
        border-color: #9448c7;
    }
    .is-purple:hover {
        background-color: #a55cd5;
        border-color: #a55cd5;
    }
    </style>
    
</head>
<body>
    <nav class="navbar is-black" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
          <a class="navbar-item is-spaced" href="index.html">
            <img src="ShaderShopLogoV2_white.png" width="112" height="58" class="">
          </a>
      
          <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarBasicExample">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
          </a>
        </div>
      
        <div id="navbarBasicExample" class="navbar-menu">
          <div class="navbar-start">
            <a class="navbar-item">
              Browse
            </a>
      
            <a class="navbar-item">
              Docs
            </a>
      
            <div class="navbar-item has-dropdown is-hoverable">
              <a class="navbar-link">
                More Tools
              </a>
      
              <div class="navbar-dropdown">
                <a class="navbar-item">
                  Shader Exporter
                </a>
                <a class="navbar-item">
                  Shader Converter
                </a>
                <a class="navbar-item">
                  ShaderShop to Unity
                </a>
                <hr class="navbar-divider">
                <a class="navbar-item">
                  Report an issue
                </a>
              </div>
            </div>
          </div>
      
          <div class="navbar-end">
            <div class="navbar-item">
              <div class="buttons">
                <a class="button is-purple">
                  <strong>New</strong>
                </a>
                <a class="button is-light">
                  Log in
                </a>
              </div>
            </div>
          </div>
        </div>
      </nav>
    
      <div class="section">
        <div class="tile is-5" id="shaderViewer">
            <div class="tile is-child">
                <canvas id="shader"></canvas>
            </div>
           
        </div>
        <div class="tile is-7">
            <div id="editor" class="tile is-child">precision mediump float;
varying vec2 a_pos;
uniform float u_time;
uniform vec2 u_mouse;

float lerp(float a, float b, float t){
    return a + (b-a) * t;
}

float llerp(float t){
    return t;
}

float squaredlerp(float t){
    return t*t;
}

float quadlerp(float t){
    return 1.0 - (1.0 - t) * (1.0 - t);
}

float ss(float t){
    return lerp(quadlerp(t),squaredlerp(t),t);
}

float circle(vec2 uv, float r,float x, float y){
    return ss(lerp(0.0,1.0,ss(((uv.x-x)*uv.x)/r+((uv.y-y)*uv.y)/r)));
}

vec3 lerpcolor(vec3 a, vec3 b, float t){
    float abr = lerp(a.r,b.r,ss(t));
    float abg = lerp(a.g,b.g,ss(t));
    float abb = lerp(a.b,b.b,ss(t));
    return vec3(abr,abg,abb);
}
void mainImage( out vec4 c, in vec2 fc )
{
    vec2 uv = fc;;
    float s = 0.1;
    float l = lerp(0.0,1.0,ss(s));
    
    float ci = circle(uv,0.5,0.0,0.0);
    vec3 color = vec3(0.0);
    
    vec3 cmix1 = vec3(0.102, 1.0, 0.1922);
    vec3 cmix2 = vec3(0.0471, 0.3451, 0.9412);
    vec3 cres = lerpcolor(cmix1,cmix2,uv.x*uv.x*sin(u_time)+uv.y*uv.y*cos(u_time));
    
    color += 1.0-ci;
    color += cres;
    
    
    c = vec4(color,1.0);
}

void main(void) {

    vec2 uv = a_pos;
    mainImage(gl_FragColor, uv);
}
            </div>
        </div>
       <div class="section">
            <button class="button is-success" id="compileBtn">Compile</button>
            <div class="tile is-2">
              <input type="number" id="fontSizeInp" class="input"></input><span style="color:white;">Font Size</span>
            <button class="button is-success" id="saveFontSizeBtn">Save</button>
            </div>
            

       </div>
      </div>
    
    <div class="section">
        <p id="fps" style="color:black;">FPS:</p>
    </div>
    <script src="js/ace.js" type="text/javascript" charset="utf-8"></script>
    <script type="module" src="js/firebaseconfig.js"></script>
    <script>
        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/one_dark");
        editor.session.setMode("ace/mode/glsl");

        editor.setOption("fontSize", "16px");
        function changeEditorFontSize(size) {
            editor.setOption("fontSize", size + "px");
        }

        var fontSizeInp = document.getElementById("fontSizeInp");
        var saveFontSizeBtn = document.getElementById("saveFontSizeBtn");

        saveFontSizeBtn.addEventListener("click", function () {
            changeEditorFontSize(fontSizeInp.value);
        });
/*fetch("shader.glsl")
    .then((res) => res.text())
    .then((fragCode) => {

        

    })
    .catch(console.error);*/

const canvas = document.querySelector("#shader");
    var width = 500;
    var height = 500;
    canvas.width = width;
    canvas.height = height;
    var isInitialRender = true;

    const gl = canvas.getContext("webgl");
    var fragCode = editor.getValue();

    var verts = [
        -1,  1,
        1,  1,
        1, -1,
        -1, -1,
    ];

    var indices = [0, 1, 3, 1, 2, 3];
    var vbuf = gl.createBuffer();

    gl.bindBuffer(gl.ARRAY_BUFFER, vbuf);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verts), gl.STATIC_DRAW);
    gl.bindBuffer(gl.ARRAY_BUFFER, null);

    var ibuf = gl.createBuffer();

    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf);
    gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null);

    var vertCode =
    'attribute vec2 v_pos;' +
    'varying vec2 a_pos;' +
        
    'void main(void) {' +
        'a_pos = v_pos;' +
        'gl_Position = vec4(v_pos, 0.0, 1.0);' +
    '}';

    var vertShader = gl.createShader(gl.VERTEX_SHADER);
    gl.shaderSource(vertShader, vertCode);
    gl.compileShader(vertShader);

    var fragShader = gl.createShader(gl.FRAGMENT_SHADER);
    gl.shaderSource(fragShader, fragCode); 
    gl.compileShader(fragShader);

    var msg = gl.getShaderInfoLog(fragShader);

    if (msg) console.error(msg);

    const prog = gl.createProgram();

    gl.attachShader(prog, vertShader);
    gl.attachShader(prog, fragShader);
    gl.linkProgram(prog);
    gl.useProgram(prog);
    gl.bindBuffer(gl.ARRAY_BUFFER, vbuf);
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, ibuf);
    const coord = gl.getAttribLocation(prog, "v_pos");
    gl.vertexAttribPointer(coord, 2, gl.FLOAT, false, 0, 0); 
    gl.enableVertexAttribArray(coord);

    gl.clearColor(0, 0, 0, 1);
    gl.viewport(0, 0, canvas.width, canvas.height);
    gl.enable(gl.DEPTH_TEST);

    const timeLoc = gl.getUniformLocation(prog, "u_time");
    const mouseLoc = gl.getUniformLocation(prog, "u_mouse");
    let mouseX = 0;
    let mouseY = 0;

    canvas.addEventListener("mousemove", (e) => {
        mouseX = e.clientX / canvas.width;
        mouseY = 1.0 - e.clientY / canvas.height;
    });
    var frame = (t) => {
            gl.uniform1f(timeLoc, t / 1000);
            gl.uniform2f(mouseLoc, mouseX, mouseY);
            gl.clear(gl.COLOR_BUFFER_BIT);
            gl.drawElements(gl.TRIANGLES, indices.length, gl.UNSIGNED_SHORT, 0);
            requestAnimationFrame(frame);
    };

    frame();



document.getElementById("compileBtn").addEventListener("click", function() {
    isInitialRender = false;

    fragCode = editor.getValue();
    gl.detachShader(prog, fragShader);
    //gl.deleteShader(fragShader);

    gl.shaderSource(fragShader, fragCode); 
    gl.compileShader(fragShader);
    
    gl.attachShader(prog, fragShader);
    gl.linkProgram(prog); 
    gl.useProgram(prog);


    
})
    
    </script>
</body>
</html>